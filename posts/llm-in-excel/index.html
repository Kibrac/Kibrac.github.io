<!DOCTYPE html>
<html lang="zh"
  dir="ltr">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://kibrac.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://kibrac.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kibrac.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://kibrac.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://kibrac.github.io//apple-touch-icon.png">

<meta name="description" content=""/>

<title>
    
    在 Excel 中接入大语言模型进行批量翻译 | Kibrac
    
</title>

<link rel="canonical" href="https://kibrac.github.io/posts/llm-in-excel/"/>












<link rel="stylesheet" href="/assets/combined.min.a6824bbee0d90d5af09fed9b70395ce7076b615e315037455d903314e96ef91b.css" media="all">







  </head>

  

  
  
  

  <body class="auto">

    <div class="content">
      <header>
        

<div class="header">

    

</div>

      </header>

      <main class="main">
        





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/posts/">Posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/posts/llm-in-excel/">在 Excel 中接入大语言模型进行批量翻译</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">在 Excel 中接入大语言模型进行批量翻译</h1>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2024-09-11T17:25:38&#43;08:00">September 11, 2024</time>
      

      
    </p>

  </div>

  

  

  

  

  <div class="single-content">
    <h2 id="一思路">一、思路</h2>
<p>将大语言模型通过编写宏封装为函数，进而对 Excel 表格中的内容进行批量翻译。</p>
<h2 id="二工具准备">二、工具准备</h2>
<p>演示使用的软件是 Microsoft Office Home and Student 2019 中的 Excel，另外还需要一个可用的大语言模型的 API key，此处以智谱 AI 的 GLM-4 为例。关于 API key 的获取有很多参考教程这里不进行赘述。</p>
<h2 id="三代码编写">三、代码编写</h2>
<ol>
<li>打开 Excel 中的 VBA 编辑器。</li>
</ol>
<blockquote>
<ul>
<li>我们可以通过以下方式找到 VBA 编辑器。
<ul>
<li>按下快捷键 Alt+F11 直接打开</li>
<li>从菜单栏中的“开发工具”中选择 <code>Visual Basic</code>
<ul>
<li>如果你的菜单中没有“开发工具”选项，可以通过“文件”&gt;“选项”&gt;“自定义功能区”中勾选“开发工具”来添加它</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<ol start="2">
<li>
<p>插入新模块
在编辑器菜单中选择 <code>插入</code> - <code>模块</code>，添加一个新的模块。</p>
</li>
<li>
<p>编写 VBA 代码。
以下代码是根据<a href="https://mp.weixin.qq.com/s/kilElUpJfFaS4Oi3qhkWcw">参考教程</a>中的代码以及智谱 AI 提供的<a href="https://open.bigmodel.cn/dev/api#glm-4">接口文档</a>进行改写得到。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vb" data-lang="vb"><span style="display:flex;"><span><span style="color:#ca9ee6">Function</span> <span style="color:#8caaee">zhipu</span>(prompt <span style="color:#99d1db;font-weight:bold">As</span> <span style="color:#e78284">String</span>) <span style="color:#99d1db;font-weight:bold">As</span> <span style="color:#e78284">String</span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 声明变量
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    <span style="color:#ca9ee6">Dim</span> url <span style="color:#99d1db;font-weight:bold">As</span> <span style="color:#e78284">String</span>, apiKey <span style="color:#99d1db;font-weight:bold">As</span> <span style="color:#e78284">String</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">Dim</span> response <span style="color:#99d1db;font-weight:bold">As</span> <span style="color:#e78284">Object</span>, json <span style="color:#99d1db;font-weight:bold">As</span> <span style="color:#e78284">String</span>, data <span style="color:#99d1db;font-weight:bold">As</span> <span style="color:#e78284">String</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">Dim</span> ws <span style="color:#99d1db;font-weight:bold">As</span> Worksheet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 设置指向第一个工作表
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    <span style="color:#ca9ee6">Set</span> ws <span style="color:#99d1db;font-weight:bold">=</span> ThisWorkbook.Sheets(1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 从工作表的B1单元格获取API密钥
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    apiKey <span style="color:#99d1db;font-weight:bold">=</span> ws.Range(<span style="color:#a6d189">&#34;B1&#34;</span>).Value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 检查API密钥是否为空
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    <span style="color:#ca9ee6">If</span> apiKey <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#a6d189">&#34;&#34;</span> <span style="color:#ca9ee6">Then</span>
</span></span><span style="display:flex;"><span>        MsgBox <span style="color:#a6d189">&#34;请在Sheet1的B1单元格中填写apiKey&#34;</span>, vbExclamation
</span></span><span style="display:flex;"><span>        zhipu <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#a6d189">&#34;Error: API key is missing&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">Exit</span> <span style="color:#ca9ee6">Function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8caaee">End</span> <span style="color:#ca9ee6">If</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 设置请求URL
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    url <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#a6d189">&#34;https://open.bigmodel.cn/api/paas/v4/chat/completions&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 替换特殊字符，并构建要发送的JSON数据
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    <span style="color:#ca9ee6">Dim</span> cleanPrompt <span style="color:#99d1db;font-weight:bold">As</span> <span style="color:#e78284">String</span>
</span></span><span style="display:flex;"><span>    cleanPrompt <span style="color:#99d1db;font-weight:bold">=</span> Replace(prompt, <span style="color:#a6d189">&#34;&#34;&#34;&#34;</span>, <span style="color:#a6d189">&#34;\&#34;&#34;&#34;</span>)  <span style="color:#737994;font-style:italic">&#39; 转义双引号
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    cleanPrompt <span style="color:#99d1db;font-weight:bold">=</span> Replace(cleanPrompt, vbCrLf, <span style="color:#a6d189">&#34;\n&#34;</span>)  <span style="color:#737994;font-style:italic">&#39; 替换Excel中的换行符为JSON中的\n
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    cleanPrompt <span style="color:#99d1db;font-weight:bold">=</span> Replace(cleanPrompt, Chr(13), <span style="color:#a6d189">&#34;\n&#34;</span>)  <span style="color:#737994;font-style:italic">&#39; 替换回车符
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    cleanPrompt <span style="color:#99d1db;font-weight:bold">=</span> Replace(cleanPrompt, Chr(10), <span style="color:#a6d189">&#34;\n&#34;</span>)  <span style="color:#737994;font-style:italic">&#39; 替换换行符
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    data <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#a6d189">&#34;{&#34;&#34;model&#34;&#34;:&#34;&#34;glm-4&#34;&#34;,&#34;</span> <span style="color:#99d1db;font-weight:bold">&amp;</span> _
</span></span><span style="display:flex;"><span>          <span style="color:#a6d189">&#34;&#34;&#34;messages&#34;&#34;:[{&#34;&#34;role&#34;&#34;:&#34;&#34;user&#34;&#34;,&#34;&#34;content&#34;&#34;:&#34;&#34;&#34;</span> <span style="color:#99d1db;font-weight:bold">&amp;</span> cleanPrompt <span style="color:#99d1db;font-weight:bold">&amp;</span> <span style="color:#a6d189">&#34;&#34;&#34;}],&#34;</span> <span style="color:#99d1db;font-weight:bold">&amp;</span> _
</span></span><span style="display:flex;"><span>          <span style="color:#a6d189">&#34;&#34;&#34;temperature&#34;&#34;:0.5}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 初始化HTTP请求对象，并设置请求方法、URL和同步标志
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    <span style="color:#ca9ee6">Set</span> response <span style="color:#99d1db;font-weight:bold">=</span> CreateObject(<span style="color:#a6d189">&#34;MSXML2.ServerXMLHTTP&#34;</span>)
</span></span><span style="display:flex;"><span>    response.Open <span style="color:#a6d189">&#34;POST&#34;</span>, url, <span style="color:#ca9ee6">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 设置请求头
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    response.setRequestHeader <span style="color:#a6d189">&#34;Content-Type&#34;</span>, <span style="color:#a6d189">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>    response.setRequestHeader <span style="color:#a6d189">&#34;Authorization&#34;</span>, <span style="color:#a6d189">&#34;Bearer &#34;</span> <span style="color:#99d1db;font-weight:bold">&amp;</span> apiKey
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 发送请求和数据
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    response.Send data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 获取响应文本
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    json <span style="color:#99d1db;font-weight:bold">=</span> response.responseText
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 解析JSON响应
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    <span style="color:#ca9ee6">Dim</span> jsonObject <span style="color:#99d1db;font-weight:bold">As</span> <span style="color:#e78284">Object</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">Set</span> jsonObject <span style="color:#99d1db;font-weight:bold">=</span> JsonConverter.ParseJson(json)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">&#39; 从解析的JSON中提取所需内容并返回
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>    <span style="color:#ca9ee6">On</span> <span style="color:#ca9ee6">Error</span> <span style="color:#ca9ee6">Resume</span> <span style="color:#ca9ee6">Next</span>
</span></span><span style="display:flex;"><span>    zhipu <span style="color:#99d1db;font-weight:bold">=</span> jsonObject(<span style="color:#a6d189">&#34;choices&#34;</span>)(1)(<span style="color:#a6d189">&#34;message&#34;</span>)(<span style="color:#a6d189">&#34;content&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">If</span> Err.Number <span style="color:#99d1db;font-weight:bold">&lt;&gt;</span> 0 <span style="color:#ca9ee6">Then</span>
</span></span><span style="display:flex;"><span>        zhipu <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#a6d189">&#34;Error parsing response: &#34;</span> <span style="color:#99d1db;font-weight:bold">&amp;</span> json
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">End</span> <span style="color:#ca9ee6">If</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">On</span> <span style="color:#ca9ee6">Error</span> <span style="color:#ca9ee6">GoTo</span> 0
</span></span><span style="display:flex;"><span><span style="color:#ca9ee6">End</span> <span style="color:#ca9ee6">Function</span>
</span></span></code></pre></div><ol start="4">
<li>
<p>导入 Json 解析依赖
下载用于 JSON 解析的依赖。<a href="https://github.com/VBA-tools/VBA-JSON/blob/master/JsonConverter.bas">下载地址</a>
在编辑器菜单中选择 <code>文件</code> - <code>导入文件</code> 将下载得到的文件导入到项目中。</p>
</li>
<li>
<p>设置引用
在 VBA 编辑器中，选择 <code>工具</code> - <code>引用</code>，选中 <code>Microsoft Scripting Runtime</code>。</p>
</li>
<li>
<p>填入 API key
根据之前编写的代码在第一个工作表的 <code>B1</code> 单元格中填入 API key。</p>
</li>
<li>
<p>使用编写的函数
像在 Excel 中调用其他函数一样，在任意一个单元格中输入 <code>=zhipu(&quot;你好&quot;)</code>,正常情况下会停顿一下然后自动填入大语言模型返回的结果。</p>
</li>
</ol>
<p>到此，已经实现了在 Excel 中接入大语言模型。</p>
<h2 id="四批量翻译">四、批量翻译</h2>
<p>首先需要生成提交给大语言模型的 prompt，这里可以使用 <code>CONCATENATE</code> 函数。</p>
<blockquote>
<p>CONCATENATE 函数 是 CONCAT 函数的老版本，用来将不同单元格里的文本等内容组合起来，但不会出现间隔符号的函数。</p>
</blockquote>
<p>这里假设 <code>A2</code> 单元格为需要翻译的内容，我们可以在一个新的单元格例如 <code>B2</code> 中输入
<code>=CONCATENATE(&quot;请将以下内容翻译为中文：&quot;, A2)</code>
回车，在 <code>B2</code> 中生成发送给大语言模型的 prompt。</p>
<p>另外再选择一个新的单元格例如 <code>C2</code> 输入 <code>=zhipu(B2)</code>,回车，稍等片刻，得到翻译结果。</p>
<h2 id="五注意事项">五、注意事项</h2>
<ol>
<li>本文中使用的 API key 来源自官方开发者平台，而中转 API key 未进行过测试，并不清楚能否正常运行。<em>（从各官方网站获取 API key，可以参考其提供的接口文档来编写代码，更为简单易用）</em></li>
<li>在保存文件时，选择支持宏的 <code>xlsm</code> 格式。</li>
</ol>
<h2 id="六参考教程">六、参考教程</h2>
<p><a href="https://mp.weixin.qq.com/s/kilElUpJfFaS4Oi3qhkWcw">爽，效率再提升 10 倍，你肯定没用过的 Kimi 高阶用法</a></p>

    
  </div>

  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/posts/pdf-batch-extration/">
                        批量提取 PDF 文件中的指定信息并存储在 Excel 表格中
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


      </main>
    </div>

    <footer>
      <p>Powered by
    <a href="https://gohugo.io/">Hugo</a>
    and
    <a href="https://github.com/tomfran/typo">tomfran/typo</a>
</p>


    </footer>

  </body>

  <script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

</html>